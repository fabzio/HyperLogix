name: Deploy

on:
  push:
   branches:
    - main

jobs:
  build:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v2

        - name: Setup Java21
          uses: actions/setup-java@v2
          with:
            java-version: '21'
            distribution: 'temurin'
        - name: Build with maven
          run: mvn clean package -DskipTests
        
        - name: Setup Docker
          uses: docker/setup-buildx-action@v3

        - name: Log in to GitHub Container Registry
          uses: docker/login-action@v3
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Build Docker Server image
          run: cd server && docker build -t ghcr.io/fabzio/hyperlogix-server:latest .
        
        - name: Push Docker Server image
          run: docker push ghcr.io/fabzio/hyperlogix-server:latest
        
        - name: Build Docker Client image
          run: cd client && docker build -t ghcr.io/fabzio/hyperlogix-client:latest --build-arg VITE_API=/api/v1 --build-arg VITE_WS_HOST=${{ secrets.HOST }} .
        
        - name: Push Docker Client image
          run: docker push ghcr.io/fabzio/hyperlogix-client:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          script: |
            cd ~/app
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" > .env
            echo "DB_PASSWORD='${{ secrets.DB_PASSWORD }}'" >> .env            
            echo "DB_HOST=${{ secrets.DB_HOST }}" >> .env
            docker-compose pull
            docker-compose down
            docker-compose up -d








